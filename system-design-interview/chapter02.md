# 2장. 개략적인 규모 추정

## 2의 제곱수
제대로 된 계산 결과를 얻기 위해서는 데이터 볼륨의 단위를 2의 제곱수로 표현하면 어떻게 되는지 파악하고 있어야 한다.   
다음은 흔히 쓰이는 데이터 볼륨 단위들.

|2의 x제곱|근사치| 축약형 |
|-------|-----|-----|
|10|10^3| 1KB |
|20|10^6| 1MB |
|30|10^9| 1GB |
|40|10^12| 1TB |
|50|10^15| 1PB |

## 모든 프로그래머가 알아야 하는 응답지연 값
구글의 제프 딘이 **2010년**에 공개한 '통상적인 컴퓨터에서 구현된 연산들의 응답지연 값'

| 연산명      | 시간    |
|----------|-------|
| L1 캐시 참조 | 0.5ns |
|분기 예측 오류| 5ns|
|L2 캐시 참조| 7ns|
|뮤텍스 락/언락|100ns|
|주 메모리 참조|100ns|
|Zippy로 1KB 압축|10µs|
|1Gbps 네트워크로 2KB 전송|20µs|
|메모리에서 1MB 순차적으로 read|250µs|
|같은 데이터 센터 내에서의 메시지 왕복 지연시간|500µs|
|디스크 탐색 (seek) | 10ms|
|네트워크에서 1MB 순차적으로 read|10ms|
|디스크에서 1MB 순차적으로 read|30ms|
|한 패킷의 CA로부터 네덜란드까지의 왕복 지연 시간|150ms|

**2020년 기준** 최근 기술 동향이 반영된 수치

| 연산명      | 시간    |
|----------|-------|
| L1 캐시 참조 | 1ns   |
|분기 예측 오류| 3ns   |
|L2 캐시 참조| 4ns   |
|뮤텍스 락/언락| 17ns  |
|주 메모리 참조| 100ns |
|Zippy로 1KB 압축| 2µs   |
|일반 상용 네트워크 상에서 2KB 전송| 44ns|
|SSD상에서 임의 위치의 데이터 읽기|16µs|
|메모리에서 1MB 순차적으로 read|3µs|
|같은 데이터 센터 내에서의 패킷 왕복 지연시간|500µs|
|SSD에서 1MB 순차적으로 read|49µs|
|디스크 탐색 (seek) |2ms|
|디스크에서 1MB 순차적으로 read|825µs|
|CA에서 네덜란드까지의 패킷 왕복 지연시간|150ms|

- 두 수치를 분석한 결론
    - 메모리는 빠르지만 디스크는 아직도 느림
    - 디스크 탐색은 가능한 피하자
    - 단순한 압축 알고리즘은 빠름
    - 데이터를 인터넷으로 전송하기 전 가능하면 압축하기 (네트워크 전송 속도 < 압축 속도)
    - 데이터 센터는 보통 여러 지역에 분산되어 있고, 센터들 간에 데이터를 주고받는 데는 시간이 걸림

## 가용성에 관계된 수치들
`고가용성` : 시스템이 오랜 시간 동안 지속적으로 중단 없이 운영될 수 있는 능력을 지칭하는 용어   
고가용성은 `%` 로 표현하는데, 대부분의 서비스는 99%에서 100% 사이의 값을 가진다. (100% = 단 한 번도 중단된 적이 없음을 의미)   
Ex. 가용률 99% = 연간 장애시간 3.65일 = 개월당 장애시간 7.31시간 = 주당 장애시간 1.68시간 = 하루당 장애시간 14.40분

`SLA (Service Level Agreement)` : 서비스 사업자가 보편적으로 사용하는 용어로, 서비스 사업자와 고객 사이에 맺어진 합의를 의미   
해당 합의에는 서비스 사업자가 제공하는 서비스의 가용시간이 공식적으로 기술되어 있음

## 예제 : 트위터 QPS와 저장소 요구량 측정
### 가정
- 월간 능동 사용자 (Monthly Active User) 는 3억(3 * 10^8)명
- 50%의 사용자가 트위터를 매일 사용
- 평균적으로 각 사용자는 매일 2건의 트윗을 올림
- 미디어를 포함하는 트윗은 10% 정도
- 데이터는 5년간 보관됨

### 추정
- `QPS (Query Per Second)` 추정치
    - 일간 능동 사용자 (DAU) = 3억 * (1/2) = 1.5억
    - 평균 QPS = 1.5억 * 2트윗/24시간/3600초 = 약 3500 (=하루 전체 요청 수를 24시간으로 균등 분포)
    - 최대 QPS (Peek QPS) = 2 * QPS = 약 7000
        - 특정 시간대에 트래픽이 몰린다고 가정했을 때 보수적으로 잡는 경험치 값을 평균 QPS에 곱해줌
- 미디어 저장을 위한 저장소 요구량
    - 평균 트윗 크기
        - tweet_id : 64B
        - text : 140B
        - media : 1MB
    - 미디어 저장소 요구량 : 1.5억 * 2 * (1/10) * 1MB = 30TB/일
    - 5년간 미디어를 보관하기 위한 저장소 요구량 : 30TB * 365 * 5 = 약 55PB

## 팁
- 근사치를 활용한 계산 : `99987 / 9.1` 같은 값은 `1000,000/10` 로 간소화
- 가정들은 적어두기
- 단위를 붙이는 습관
- QPS, 최대 QPS, 저장소 요구량, 캐시 요구량, 서버 수 등을 추정하는 문제는 많이 연습해보기